# =============================================================================
# Strømkalkulator Utility Meter Package
# =============================================================================
# 
# Denne pakken setter opp utility_meter med dag/natt-tariffer for 
# nøyaktig kostnadssporing som matcher BKK-fakturaen.
#
# OPPSETT:
# 1. Kopier denne filen til /config/packages/
# 2. Aktiver packages i configuration.yaml:
#    homeassistant:
#      packages: !include_dir_named packages
# 3. Endre sensor-navnene nedenfor til dine faktiske sensorer
# 4. Start Home Assistant på nytt
#
# FORUTSETNINGER:
# - Strømkalkulator-integrasjonen er installert og konfigurert
# - Du har en energi-sensor (kWh) ELLER en effekt-sensor (W)
#
# =============================================================================

# -----------------------------------------------------------------------------
# TILPASS DISSE TIL DINE SENSORER
# -----------------------------------------------------------------------------
# Bytt ut "sensor.power_meter" med din effekt-sensor (W)
# Hvis du allerede har en kWh-sensor, kommenter ut "sensor"-seksjonen
# og bruk din kWh-sensor direkte i utility_meter source

sensor:
  # Konverter effekt (W) til energi (kWh) hvis du ikke har kWh-sensor
  - platform: integration
    source: sensor.power_meter  # <-- BYTT UT med din effekt-sensor
    name: "Strøm energiforbruk"
    unique_id: stromkalkulator_energiforbruk
    unit_prefix: k
    round: 3
    method: left

# -----------------------------------------------------------------------------
# UTILITY METER - Forbrukssporing med dag/natt-tariffer
# -----------------------------------------------------------------------------

utility_meter:
  # Daglig forbruk per tariff
  strom_daglig:
    source: sensor.strom_energiforbruk  # <-- Eller din kWh-sensor
    name: "Strøm daglig"
    unique_id: stromkalkulator_daglig
    cycle: daily
    tariffs:
      - dag
      - natt

  # Månedlig forbruk per tariff
  strom_maanedlig:
    source: sensor.strom_energiforbruk  # <-- Eller din kWh-sensor
    name: "Strøm månedlig"
    unique_id: stromkalkulator_maanedlig
    cycle: monthly
    tariffs:
      - dag
      - natt

  # Årlig forbruk per tariff
  strom_aarlig:
    source: sensor.strom_energiforbruk
    name: "Strøm årlig"
    unique_id: stromkalkulator_aarlig
    cycle: yearly
    tariffs:
      - dag
      - natt

# -----------------------------------------------------------------------------
# TEMPLATE SENSORER - Kostnadsberegning
# -----------------------------------------------------------------------------

template:
  - sensor:
      # Månedlig strømkostnad (energiledd + kapasitetsledd)
      - name: "Månedlig nettleie kostnad"
        unique_id: stromkalkulator_maanedlig_nettleie_kostnad
        unit_of_measurement: "kr"
        device_class: monetary
        icon: mdi:currency-usd
        state: >
          {% set dag_kwh = states('sensor.strom_maanedlig_dag') | float(0) %}
          {% set natt_kwh = states('sensor.strom_maanedlig_natt') | float(0) %}
          {% set dag_pris = states('sensor.energiledd_dag') | float(0.46) %}
          {% set natt_pris = states('sensor.energiledd_natt_helg') | float(0.23) %}
          {% set kapasitet = states('sensor.kapasitetstrinn') | float(0) %}
          {{ ((dag_kwh * dag_pris) + (natt_kwh * natt_pris) + kapasitet) | round(2) }}
        attributes:
          dag_forbruk_kwh: "{{ states('sensor.strom_maanedlig_dag') | float(0) | round(1) }}"
          natt_forbruk_kwh: "{{ states('sensor.strom_maanedlig_natt') | float(0) | round(1) }}"
          dag_kostnad: "{{ (states('sensor.strom_maanedlig_dag') | float(0) * states('sensor.energiledd_dag') | float(0.46)) | round(2) }}"
          natt_kostnad: "{{ (states('sensor.strom_maanedlig_natt') | float(0) * states('sensor.energiledd_natt_helg') | float(0.23)) | round(2) }}"
          kapasitetsledd: "{{ states('sensor.kapasitetstrinn') | float(0) | round(0) }}"

      # Månedlig forbruksavgift
      - name: "Månedlig forbruksavgift"
        unique_id: stromkalkulator_maanedlig_forbruksavgift
        unit_of_measurement: "kr"
        device_class: monetary
        icon: mdi:lightning-bolt
        state: >
          {% set total_kwh = states('sensor.strom_maanedlig_dag') | float(0) + states('sensor.strom_maanedlig_natt') | float(0) %}
          {% set avgift = states('sensor.forbruksavgift') | float(0.0891) %}
          {{ (total_kwh * avgift) | round(2) }}

      # Månedlig Enova-avgift
      - name: "Månedlig Enovaavgift"
        unique_id: stromkalkulator_maanedlig_enovaavgift
        unit_of_measurement: "kr"
        device_class: monetary
        icon: mdi:leaf
        state: >
          {% set total_kwh = states('sensor.strom_maanedlig_dag') | float(0) + states('sensor.strom_maanedlig_natt') | float(0) %}
          {% set avgift = states('sensor.enovaavgift') | float(0.0125) %}
          {{ (total_kwh * avgift) | round(2) }}

      # Besparelse vs Norgespris
      - name: "Besparelse vs Norgespris"
        unique_id: stromkalkulator_besparelse_norgespris
        unit_of_measurement: "kr"
        device_class: monetary
        icon: mdi:piggy-bank
        state: >
          {% set total_kwh = states('sensor.strom_maanedlig_dag') | float(0) + states('sensor.strom_maanedlig_natt') | float(0) %}
          {% set diff_per_kwh = states('sensor.prisforskjell_norgespris') | float(0) %}
          {{ (total_kwh * diff_per_kwh * -1) | round(2) }}
        attributes:
          note: "Positiv = du sparer, Negativ = du taper vs Norgespris (50 øre/kWh)"

# -----------------------------------------------------------------------------
# AUTOMATISERING - Tariff-bytte
# -----------------------------------------------------------------------------

automation:
  - id: stromkalkulator_tariff_bytte
    alias: "Strømkalkulator: Oppdater tariff"
    description: "Bytter utility_meter tariff basert på dag/natt fra Strømkalkulator"
    trigger:
      - platform: state
        entity_id: sensor.tariff
        not_to:
          - unavailable
          - unknown
    condition: []
    action:
      - service: select.select_option
        target:
          entity_id:
            - select.strom_daglig
            - select.strom_maanedlig
            - select.strom_aarlig
        data:
          option: "{{ trigger.to_state.state }}"
    mode: single

  # Alternativ: Trigger ved oppstart for å sette riktig tariff
  - id: stromkalkulator_tariff_oppstart
    alias: "Strømkalkulator: Sett tariff ved oppstart"
    description: "Setter riktig tariff når Home Assistant starter"
    trigger:
      - platform: homeassistant
        event: start
    condition:
      - condition: state
        entity_id: sensor.tariff
        state:
          - dag
          - natt
    action:
      - delay: "00:00:30"  # Vent til sensorer er klare
      - service: select.select_option
        target:
          entity_id:
            - select.strom_daglig
            - select.strom_maanedlig
            - select.strom_aarlig
        data:
          option: "{{ states('sensor.tariff') }}"
    mode: single
